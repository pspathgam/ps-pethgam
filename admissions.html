<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admissions 2025-26 ‚Äî Government Primary School Pethgam Wagoora</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- 3rd-party libs (load first) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --brand-a:#00796b; --brand-b:#00bfa5; --accent:#ffb300; --bg:#f0fbff;
      --card:#ffffff; --muted:#666;
    }
    *{box-sizing:border-box}
    body{font-family: "Nunito", Arial, sans-serif; margin:0; background:var(--bg); color:#222; -webkit-font-smoothing:antialiased;}
    header{background:linear-gradient(135deg,var(--brand-a),#00695c); color:#fff; padding:18px 12px; position:relative; overflow:hidden;}
    .container{width:94%; max-width:1200px; margin:18px auto;}
    .header-inner{display:flex; align-items:center; gap:12px;}
    .logo{width:80px;height:80px;border-radius:10px;background:#fff2;font-weight:800;display:flex;align-items:center;justify-content:center;color:#004d40;font-size:18px;}
    header h1{font-size:20px;margin:0}
    header p{margin:4px 0 0; font-size:14px; opacity:0.95}
    .details-bar{display:flex; gap:12px;justify-content:center; background:#e0f2f1; color:#004d40; padding:8px 10px; margin-top:12px; border-radius:6px; font-weight:700;}
    .scrolling-banner{background:#fff3; color:#b71c1c; padding:8px 12px; margin:16px 0; border-left:6px solid #ffeb3b; overflow:hidden; white-space:nowrap; border-radius:6px;}
    .scrolling-banner > div{display:inline-block; padding-left:100%; animation:scroll 28s linear infinite;}
    @keyframes scroll{to{transform:translateX(-100%)}}

    /* Tabs nav */
    .tabs-nav{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px;}
    .tab-btn{
      padding:12px 18px; border-radius:12px; border:none; background:linear-gradient(180deg,#eee,#ddd);
      cursor:pointer; font-weight:800; box-shadow:0 6px 0 rgba(0,0,0,0.08); transform:translateY(0); transition:all .18s ease;
    }
    .tab-btn:hover{transform:translateY(-6px); box-shadow:0 12px 18px rgba(0,0,0,0.12); background: linear-gradient(180deg,var(--brand-b),var(--brand-a)); color:white}
    .tab-btn.active{background:linear-gradient(180deg,var(--brand-b),var(--brand-a)); color:white; transform:translateY(-6px); box-shadow:0 12px 18px rgba(0,0,0,0.12);}

    .card{background:var(--card); padding:16px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); margin-bottom:18px;}
    .tab-content{display:none;}
    .tab-content.active{display:block;}

    h2{color:var(--brand-a); margin:0 0 10px 0; font-size:18px}
    form .row{display:flex; gap:12px}
    form .col{flex:1}
    label{display:block; font-weight:700; margin:8px 0 6px; font-size:13px}
    input[type=text], input[type=date], input[type=email], select, textarea{width:100%; padding:10px; border-radius:6px; border:1px solid #d7e6e2}
    textarea{min-height:80px; resize:vertical}
    .form-actions{display:flex; gap:10px; justify-content:center; margin-top:14px}
    .btn{padding:10px 14px; border-radius:8px; border:none; font-weight:800; cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,var(--brand-b),var(--brand-a)); color:white}
    .btn.ghost{background:transparent; border:2px solid var(--brand-a); color:var(--brand-a)}
    .small{font-size:13px; color:var(--muted)}

    table{width:100%; border-collapse:collapse; margin-top:10px}
    th,td{padding:8px;border:1px solid #e6f0ee; text-align:left; font-size:13px}
    th{background:#e8f6f2; color:var(--brand-a)}
    .actions a{margin-right:8px; cursor:pointer; color:var(--brand-a); text-decoration:underline}

    /* camera preview */
    #photoPreview{width:140px;height:160px;object-fit:cover;border:1px solid #ccc;border-radius:6px}

    /* responsive */
    @media (max-width:800px){
      .header-inner{flex-direction:column; align-items:flex-start}
      .details-bar{flex-direction:column; gap:6px}
      form .row{flex-direction:column}
    }
  </style>
</head>
<body>
  <header>
    <div class="container header-inner">
      <div class="logo">GPS<br>Pethgam</div>
      <div>
        <h1>Government Primary School Pethgam Wagoora</h1>
        <p>Wagoora Babareshi Road ‚Äî Near Zonal Education Office, Wagoora ¬∑ UDISE: 01022202207 ¬∑ Zone: Wagoora ¬∑ Session: 2025‚Äì26</p>
      </div>
    </div>
    <div class="container">
      <div class="details-bar">
        <div>üìû Contact: <strong>9596449881</strong></div>
        <div>üìß Email: <strong>pspethgam@gmail.com</strong></div>
        <div>üìÖ Admission: <strong>01/11/2025</strong> ‚Äî <strong>15/04/2026</strong></div>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="scrolling-banner card"><div>üì¢ Admission Opening: 01/11/2025 | Admission Closing: 15/04/2026 | Submit printed Admission & Apaar forms at the school office. &nbsp;&nbsp;&nbsp;</div></div>

    <!-- Tabs -->
    <div class="tabs-nav card" role="tablist" aria-label="Admission Navigation">
      <button class="tab-btn tab-link" data-tab="guidelines" onclick="openTab('guidelines')">üìå Guidelines</button>
      <button class="tab-btn tab-link" data-tab="applyOnline" onclick="openTab('applyOnline')">üñ•Ô∏è Apply Online</button>
      <button class="tab-btn tab-link" data-tab="apaarForm" onclick="openTab('apaarForm')">üìÑ Apaar Form</button>
      <button class="tab-btn tab-link" data-tab="admissionRegister" onclick="openTab('admissionRegister')">üìò Admission Register</button>
      <button class="tab-btn tab-link" data-tab="requiredDocs" onclick="openTab('requiredDocs')">üìë Required Documents</button>
      <button class="tab-btn tab-link" data-tab="downloads" onclick="openTab('downloads')">üì• Downloads</button>
    </div>

    <!-- GUIDELINES -->
    <section id="guidelines" class="tab-content card" role="tabpanel">
      <h2>Admission Guidelines</h2>
      <p class="small">Age eligibility is calculated <strong>as on 01-Nov-2025</strong>. All documents listed in Required Documents are <strong>mandatory</strong>. Apply online to generate the Admission Form & Apaar Form PDFs. Submit printed copies at the school office.</p>

      <table>
        <thead><tr><th>Class</th><th>Minimum Age (on 01-Nov-2025)</th></tr></thead>
        <tbody>
          <tr><td>Pre Primary-3</td><td>3+</td></tr>
          <tr><td>Pre Primary-2</td><td>4+</td></tr>
          <tr><td>Balvatika</td><td>5+</td></tr>
          <tr><td>1st Primary</td><td>6+</td></tr>
          <tr><td>2nd Primary</td><td>7+</td></tr>
          <tr><td>3rd Primary</td><td>8+</td></tr>
          <tr><td>4th Primary</td><td>9+</td></tr>
          <tr><td>5th Primary</td><td>10+</td></tr>
        </tbody>
      </table>
    </section>

    <!-- APPLY ONLINE -->
    <section id="applyOnline" class="tab-content card" role="tabpanel">
      <h2>Apply Online ‚Äî Admission Form</h2>
      <p class="small">Fill all fields. On submit the system will validate age eligibility (01-Nov-2025). It will then generate two A4 PDFs (Admission Form + Apaar Form) and store the record in the local Admission Register.</p>

      <form id="admissionForm" onsubmit="return handleSubmit(event)" autocomplete="off" class="card" style="padding:14px;">
        <div class="row">
          <div class="col">
            <label for="studentName">Student Full Name *</label>
            <input id="studentName" type="text" required>
          </div>
          <div class="col">
            <label for="gender">Gender *</label>
            <select id="gender" required><option value="">Select</option><option>Male</option><option>Female</option><option>Other</option></select>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label for="dob">Date of Birth *</label>
            <input id="dob" type="date" required>
          </div>
          <div class="col">
            <label for="classApplying">Class Applying For *</label>
            <select id="classApplying" required>
              <option value="">Select</option>
              <option>Pre Primary-3</option><option>Pre Primary-2</option><option>Balvatika</option>
              <option>1st Primary</option><option>2nd Primary</option><option>3rd Primary</option>
              <option>4th Primary</option><option>5th Primary</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label for="aadhaarStudent">Aadhaar Number (Student) *</label>
            <input id="aadhaarStudent" type="text" inputmode="numeric" pattern="\d*" placeholder="Optional for offline" >
          </div>
          <div class="col">
            <label for="bloodGroup">Blood Group *</label>
            <select id="bloodGroup" required><option value="">Select</option><option>A+</option><option>A-</option><option>B+</option><option>B-</option><option>O+</option><option>O-</option><option>AB+</option><option>AB-</option></select>
          </div>
        </div>

        <div style="display:flex; gap:12px; align-items:flex-end; margin-top:6px;">
          <div>
            <label for="photo">Upload Photo (passport size) *</label>
            <input id="photo" type="file" accept="image/*" />
            <div style="margin-top:6px;">
              <label for="cameraCapture" style="font-weight:700; display:block; margin-top:8px;">Or take photo with camera</label>
              <input id="cameraCapture" type="file" accept="image/*" capture="environment">
            </div>
          </div>
          <div style="margin-left:auto; text-align:center;">
            <div style="font-weight:700; margin-bottom:6px;">Photo Preview</div>
            <img id="photoPreview" src="" alt="Photo preview" />
          </div>
        </div>

        <div class="row" style="margin-top:8px;">
          <div class="col">
            <label for="penNumber">PEN Number (Optional)</label>
            <input id="penNumber" type="text" placeholder="If available">
          </div>
          <div class="col">
            <label for="previousSchool">Previous School (If any)</label>
            <input id="previousSchool" type="text" placeholder="For 2nd‚Äì5th">
          </div>
        </div>

        <h2 style="margin-top:14px; font-size:16px;">Parents‚Äô Details</h2>
        <div class="row">
          <div class="col">
            <label for="fatherName">Father's Name *</label>
            <input id="fatherName" type="text" required>
          </div>
          <div class="col">
            <label for="motherName">Mother's Name *</label>
            <input id="motherName" type="text" required>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label for="fatherProfession">Father's Profession *</label>
            <input id="fatherProfession" type="text" placeholder="e.g. Farmer / Govt Employee / Labour" required>
          </div>
          <div class="col">
            <label for="motherProfession">Mother's Profession *</label>
            <input id="motherProfession" type="text" required>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label for="parentsPhone">Parents' Phone Number(s) *</label>
            <input id="parentsPhone" type="text" required>
          </div>
          <div class="col">
            <label for="address">Address *</label>
            <input id="address" type="text" required>
          </div>
        </div>

        <h2 style="margin-top:14px; font-size:16px;">Bank Details (for records)</h2>
        <div class="row">
          <div class="col"><label for="bankName">Bank Name *</label><input id="bankName" type="text" required></div>
          <div class="col"><label for="accountNumber">Account Number *</label><input id="accountNumber" type="text" required></div>
        </div>

        <div style="margin-top:12px;">
          <label for="tcUpload">Transfer Certificate (if applicable)</label>
          <input id="tcUpload" type="file" accept="image/*,application/pdf">
        </div>

        <div class="form-actions">
          <button type="button" class="btn ghost" onclick="previewPdfs()">Preview PDF</button>
          <button type="submit" class="btn primary">Submit & Generate PDFs</button>
          <button type="reset" class="btn" style="background:#e57373;color:#fff" onclick="clearPhotoPreview()">Reset</button>
        </div>
      </form>
    </section>

    <!-- APAAR FORM -->
    <section id="apaarForm" class="tab-content card" role="tabpanel">
      <h2>Apaar Consent Text</h2>
      <div style="white-space:pre-wrap; font-size:14px; line-height:1.4; color:#222;">
GOVERNMENT PRIMARY SCHOOL PETHGAM WAGOORA
Wagoora Babareshi Road Near Zonal Education Office Wagoora

UDISE Code: 01022202207.
Zone: Wagoora

Consent by Father/Mother/Legal Guardian of Student for APAAR ID Generation

I, ________________________ (Father / Mother / Legal Guardian) of ________________________ with my identity proof as (Aadhar / PAN / EPIC Voter ID / Driving License / Passport) and Identity Proof Number ________________________ voluntarily give my consent to share his/her Aadhaar Number and demographic information issued by UIDAI with Ministry of Education for the sole purpose of creation of APAAR ID and opening of DIGILOCKER account of my child for the following intents and purposes.

I understand that my APAAR ID may be used and shared for limited purposes as notified by Ministry of Education. I authorise Ministry of Education to use my Aadhaar number for performing Aadhaar based authentication with UIDAI as per the Aadhaar Act, 2016. I understand that the information shared shall be kept confidential. I can withdraw my consent anytime and such withdrawal will stop further processing (already processed data remains).
      </div>

      <p class="small" style="margin-top:12px">When generating the Apaar PDF the above consent block will be included and pre-filled with student's & parent's info from the Admission Form.</p>
    </section>

    <!-- ADMISSION REGISTER -->
    <section id="admissionRegister" class="tab-content card" role="tabpanel">
      <h2>Admission Register</h2>
      <div style="display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap;">
        <input id="searchRegister" placeholder="Search by Name / PEN / Class" style="flex:1; padding:8px; border-radius:6px; border:1px solid #d7e6e2">
        <select id="filterClass" style="padding:8px; border-radius:6px; border:1px solid #d7e6e2">
          <option value="">Filter by Class</option>
          <option>Pre Primary-3</option><option>Pre Primary-2</option><option>Balvatika</option>
          <option>1st Primary</option><option>2nd Primary</option><option>3rd Primary</option>
          <option>4th Primary</option><option>5th Primary</option>
        </select>
        <button class="btn ghost" onclick="exportRegisterPDF()">Export (PDF)</button>
        <button class="btn ghost" onclick="exportRegisterCSV()">Export (CSV)</button>
      </div>

      <div style="overflow-x:auto">
        <table id="registerTable" aria-live="polite">
          <thead>
            <tr><th>S. No.</th><th>Date</th><th>Adm. No.</th><th>Student Name</th><th>Class</th><th>DOB</th><th>PEN No.</th><th>Blood Group</th><th>Parents</th><th>Bank (last4)</th><th>Status</th><th>PDFs</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="small" style="margin-top:8px">Admission Status is editable only here (Active / Struck Off / D.C. Issued).</p>
    </section>

    <!-- REQUIRED DOCS -->
    <section id="requiredDocs" class="tab-content card" role="tabpanel">
      <h2>Required Documents (All Mandatory)</h2>
      <ul>
        <li>Birth Certificate</li>
        <li>Aadhaar Card (Student)</li>
        <li>Aadhaar Card (Father/Mother)</li>
        <li>Bank Passbook Copy (Student account)</li>
        <li>Blood Group Report</li>
        <li>Two Passport Size Photographs (physical)</li>
        <li>Transfer Certificate (for 2nd‚Äì5th Primary)</li>
        <li>Previous School Record (if applicable)</li>
      </ul>
    </section>

    <!-- DOWNLOADS -->
    <section id="downloads" class="tab-content card" role="tabpanel">
      <h2>Downloads</h2>
      <ul>
        <li>‚¨áÔ∏è <a href="javascript:void(0)" onclick="downloadBlank('admission')">Blank Admission Form (A4)</a></li>
        <li>‚¨áÔ∏è <a href="javascript:void(0)" onclick="downloadBlank('apaar')">Blank Apaar Form (A4)</a></li>
        <li>‚¨áÔ∏è <a href="javascript:void(0)" onclick="alert('Prospectus download - replace this with real file link on your server')">Prospectus</a></li>
        <li>‚¨áÔ∏è <a href="javascript:void(0)" onclick="alert('Checklist download - replace with your file link')">Required Documents Checklist</a></li>
      </ul>
    </section>

  </main>

  <footer class="container card" style="margin-top:18px; text-align:center;">
    <strong>Contact:</strong> 9596449881 &nbsp; | &nbsp; <strong>Email:</strong> pspethgam@gmail.com
  </footer>

  <script>
    // ensure libraries are available globally
    window.html2canvas = window.html2canvas || window.html2canvas || html2canvas;
    const { jsPDF } = window.jspdf || (window.jspdf = window.jspdf || {});

    // APAAR consent block used in the PDF
    const APAAR_CONSENT = `GOVERNMENT PRIMARY SCHOOL PETHGAM WAGOORA
Wagoora Babareshi Road Near Zonal Education Office Wagoora

UDISE Code: 01022202207.
Zone: Wagoora

Consent by Father/Mother/Legal Guardian of Student for APAAR ID Generation

I, ________________________ (Father / Mother / Legal Guardian) of ________________________ with my identity proof as (Aadhar / PAN / EPIC Voter ID / Driving License / Passport) and Identity Proof Number ________________________ voluntarily give my consent to share his/her Aadhaar Number and demographic information issued by UIDAI with Ministry of Education for the sole purpose of creation of APAAR ID and opening of DIGILOCKER account of my child for the following intents and purposes.

I understand that my APAAR ID may be used and shared for limited purposes as notified by Ministry of Education. I authorise Ministry of Education to use my Aadhaar number for performing Aadhaar based authentication with UIDAI as per the Aadhaar Act, 2016. I understand that the information shared shall be kept confidential. I can withdraw my consent anytime and such withdrawal will stop further processing (already processed data remains).`;

    /* ---------- Tabs ---------- */
    function openTab(tabName){
      document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      const content = document.getElementById(tabName);
      if(content) content.classList.add('active');
      const btn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
      if(btn) btn.classList.add('active');
      window.scrollTo({top:0, behavior:'smooth'});
    }

    // Set defaults when DOM ready
    window.addEventListener('DOMContentLoaded', ()=> {
      openTab('guidelines');
      loadRegister();
      const dobEl = document.getElementById('dob');
      if(dobEl) dobEl.max = '2025-11-01';

      // wire photo inputs (upload + camera)
      const photoIn = document.getElementById('photo');
      const cameraIn = document.getElementById('cameraCapture');
      [photoIn, cameraIn].forEach(inp=>{
        if(!inp) return;
        inp.addEventListener('change', async (e)=> {
          const f = e.target.files && e.target.files[0];
          if(!f) return;
          const url = await fileInputToDataURL(e.target);
          document.getElementById('photoPreview').src = url;
        });
      });

      // search & filter
      const searchEl = document.getElementById('searchRegister');
      if(searchEl){
        searchEl.addEventListener('input', function(){
          const q = this.value.trim().toLowerCase();
          const arr = JSON.parse(localStorage.getItem('aps_register_v1') || '[]');
          const filtered = arr.filter(r => {
            return (r.studentName||'').toLowerCase().includes(q) || (r.penNumber||'').toLowerCase().includes(q) || (r.classApplying||'').toLowerCase().includes(q);
          });
          renderRegister(filtered);
        });
      }
      const filterEl = document.getElementById('filterClass');
      if(filterEl){
        filterEl.addEventListener('change', function(){
          const cls = this.value;
          const arr = JSON.parse(localStorage.getItem('aps_register_v1') || '[]');
          const filtered = cls ? arr.filter(r=> r.classApplying===cls) : arr;
          renderRegister(filtered);
        });
      }
    });

    /* ---------- Utilities ---------- */
    function calcAgeOn(dobStr, onDateStr){
      const dob = new Date(dobStr);
      const on = new Date(onDateStr);
      if(isNaN(dob)) return -1;
      let age = on.getFullYear() - dob.getFullYear();
      const m = on.getMonth() - dob.getMonth();
      if(m < 0 || (m===0 && on.getDate() < dob.getDate())) age--;
      return age;
    }
    function isEligible(dobStr, classApplying){
      const cutoff = '2025-11-01';
      const age = calcAgeOn(dobStr, cutoff);
      const map = {'Pre Primary-3':3,'Pre Primary-2':4,'Balvatika':5,'1st Primary':6,'2nd Primary':7,'3rd Primary':8,'4th Primary':9,'5th Primary':10};
      const required = map[classApplying];
      if(required===undefined) return {ok:false, msg:'Select class.'};
      if(age>=required) return {ok:true, age};
      return {ok:false, msg:`Child is ${age} yrs on ${cutoff} ‚Äî requires ${required}+ yrs for ${classApplying}.`};
    }
    function generateAdmNo(){
      const seqKey = 'aps_adm_seq_2025';
      let seq = parseInt(localStorage.getItem(seqKey) || '0', 10);
      seq++; localStorage.setItem(seqKey, seq);
      const year = '25';
      return `${year}${String(seq).padStart(4,'0')}`;
    }
    function fileInputToDataURL(inputEl){
      return new Promise((res, rej)=>{
        const f = inputEl.files && inputEl.files[0];
        if(!f) return rej(new Error('No file'));
        const reader = new FileReader();
        reader.onload = ()=>res(reader.result);
        reader.onerror = ()=>rej(reader.error);
        reader.readAsDataURL(f);
      });
    }
    function clearPhotoPreview(){ document.getElementById('photoPreview').src = ''; }

    /* ---------- PDF helpers (use html2canvas + jsPDF) ---------- */
    async function elementToPdfBlob(element){
      // ensure html2canvas is available
      if(typeof html2canvas === 'undefined') throw new Error('html2canvas not loaded');
      const canvas = await html2canvas(element, {scale:2, useCORS:true, logging:false});
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p','mm','a4');
      const pageWidth = pdf.internal.pageSize.getWidth();
      const imgProps = pdf.getImageProperties(imgData);
      const imgH = (imgProps.height * pageWidth) / imgProps.width;
      pdf.addImage(imgData, 'PNG', 0, 0, pageWidth, imgH);
      return pdf;
    }

    function createAdmissionPrintHTML(data){
      const html = `
        <div style="font-family: Arial; padding:18px; color:#222; width:100%; max-width:794px;">
          <div style="text-align:center; margin-bottom:8px;">
            <h2 style="margin:0">Government Primary School Pethgam Wagoora</h2>
            <div>Wagoora Babareshi Road ‚Äî Near Zonal Education Office, Wagoora</div>
            <div style="font-weight:700; margin-top:6px">UDISE Code: 01022202207 | Session: 2025-26</div>
            <hr style="margin-top:12px;"/>
          </div>
          <div style="display:flex; gap:12px; flex-wrap:wrap;">
            <div style="flex:1; min-width:260px;">
              <p><strong>Admission No:</strong> ${data.admNo}</p>
              <p><strong>Admission Date:</strong> ${data.admDate}</p>
              <p><strong>Student Name:</strong> ${data.studentName}</p>
              <p><strong>Class:</strong> ${data.classApplying}</p>
              <p><strong>DOB:</strong> ${data.dob}</p>
              <p><strong>Blood Group:</strong> ${data.bloodGroup}</p>
              ${data.penNumber ? `<p><strong>PEN No:</strong> ${data.penNumber}</p>` : ''}
              <p><strong>Father:</strong> ${data.fatherName}</p>
              <p><strong>Mother:</strong> ${data.motherName}</p>
              <p><strong>Parents Phones:</strong> ${data.parentsPhone}</p>
              <p><strong>Address:</strong> ${data.address}</p>
              <p><strong>Bank:</strong> ${data.bankName} (....${String(data.accountNumber).slice(-4)})</p>
            </div>
            <div style="width:160px; text-align:center; min-width:140px;">
              ${data.photoData ? `<img src="${data.photoData}" style="width:140px;height:160px;object-fit:cover;border:1px solid #ccc;" />` : ''}
            </div>
          </div>
          <hr style="margin:14px 0"/>
          <div style="font-size:13px;">
            <strong>Note:</strong> Submit the printed Admission & Apaar form at the school office with supporting documents. All documents are mandatory.
          </div>
          <div style="margin-top:18px;">
            <div style="float:right; text-align:center;">
              <div>Signature (HoI / Authorized)</div>
              <div style="margin-top:36px;">__________________________</div>
            </div>
          </div>
        </div>`;
      const wrapper = document.createElement('div');
      wrapper.innerHTML = html;
      return wrapper;
    }
    function createApaarPrintHTML(data){
      const html = `
        <div style="font-family: Arial; padding:18px; color:#222; width:100%; max-width:794px;">
          <div style="text-align:center; margin-bottom:8px;">
            <h3 style="margin:0">APAAR Consent</h3>
            <div style="font-weight:700; margin-top:6px">Government Primary School Pethgam Wagoora</div>
            <hr style="margin-top:12px;"/>
          </div>
          <div>
            <p><strong>Student:</strong> ${data.studentName || '[Student Name]'} &nbsp; <strong>DOB:</strong> ${data.dob || '[DOB]'} &nbsp; <strong>Class:</strong> ${data.classApplying || '[Class]'}</p>
            <pre style="white-space:pre-wrap; font-size:13px; background:#f6f6f6; padding:10px; border-radius:6px;">${APAAR_CONSENT}</pre>
            <p style="margin-top:10px;">Place of Physical Consent: ____________________</p>
            <p>Date of Physical Consent: ____________________</p>
            <p>Signature of Parent / Guardian: ____________________</p>
            <hr/>
            <p style="margin-top:8px;">Consent by Head of School: ____________________ Date: __________ Signature: ____________________</p>
          </div>
        </div>`;
      const wrapper = document.createElement('div');
      wrapper.innerHTML = html;
      return wrapper;
    }

    /* ---------- Form handlers ---------- */
    async function handleSubmit(e){
      e.preventDefault();
      const data = {
        studentName: document.getElementById('studentName').value.trim(),
        gender: document.getElementById('gender').value,
        dob: document.getElementById('dob').value,
        classApplying: document.getElementById('classApplying').value,
        aadhaarStudent: document.getElementById('aadhaarStudent').value.trim(),
        bloodGroup: document.getElementById('bloodGroup').value,
        penNumber: document.getElementById('penNumber').value.trim(),
        previousSchool: document.getElementById('previousSchool').value.trim(),
        fatherName: document.getElementById('fatherName').value.trim(),
        motherName: document.getElementById('motherName').value.trim(),
        fatherProfession: document.getElementById('fatherProfession').value.trim(),
        motherProfession: document.getElementById('motherProfession').value.trim(),
        parentsPhone: document.getElementById('parentsPhone').value.trim(),
        address: document.getElementById('address').value.trim(),
        bankName: document.getElementById('bankName').value.trim(),
        accountNumber: document.getElementById('accountNumber').value.trim(),
        admDate: new Date().toLocaleDateString('en-GB'),
      };

      const eligible = isEligible(data.dob, data.classApplying);
      if(!eligible.ok){
        alert('Age Validation Error: ' + (eligible.msg || 'Not eligible for selected class.'));
        return false;
      }
      data.ageOnCutoff = eligible.age;

      // photo and TC uploads
      try{ 
        const photoEl = document.getElementById('photo');
        const camEl = document.getElementById('cameraCapture');
        // prefer camera capture if used
        if(camEl && camEl.files && camEl.files[0]){
          data.photoData = await fileInputToDataURL(camEl);
        } else if(photoEl && photoEl.files && photoEl.files[0]){
          data.photoData = await fileInputToDataURL(photoEl);
        } else {
          data.photoData = document.getElementById('photoPreview').src || '';
        }
      }catch(err){ alert('Please upload or capture a valid photo.'); return false; }

      try{
        const tc = document.getElementById('tcUpload');
        if(tc && tc.files && tc.files[0]){
          data.tcData = await fileInputToDataURL(tc);
        }
      }catch(err){ /* optional */ }

      data.admNo = generateAdmNo();

      // craft nodes, render to PDF, save and store
      const admNode = createAdmissionPrintHTML(data);
      const apaarNode = createApaarPrintHTML(data);

      admNode.style.position='fixed'; admNode.style.left='-2000px';
      apaarNode.style.position='fixed'; apaarNode.style.left='-2000px';
      document.body.appendChild(admNode);
      document.body.appendChild(apaarNode);

      try{
        const admPdf = await elementToPdfBlob(admNode);
        const apaarPdf = await elementToPdfBlob(apaarNode);
        admPdf.save(`Admission_${data.admNo}_${data.studentName.replace(/\s+/g,'_')}.pdf`);
        apaarPdf.save(`Apaar_${data.admNo}_${data.studentName.replace(/\s+/g,'_')}.pdf`);

        data.admPdf = admPdf.output('datauristring');
        data.apaarPdf = apaarPdf.output('datauristring');
        saveRecordToRegister(data);

        document.body.removeChild(admNode);
        document.body.removeChild(apaarNode);

        document.getElementById('admissionForm').reset();
        clearPhotoPreview();
        alert('Admission saved to Register and PDFs downloaded. Submit printed copies at school office.');
        openTab('admissionRegister');
      }catch(err){
        console.error(err);
        alert('Error generating PDFs: ' + (err.message || err));
        try{ document.body.removeChild(admNode); document.body.removeChild(apaarNode); }catch(e){}
      }
      return false;
    }

    function previewPdfs(){
      const data = {
        studentName: document.getElementById('studentName').value.trim() || '[Student Name]',
        dob: document.getElementById('dob').value || '[DOB]',
        classApplying: document.getElementById('classApplying').value || '[Class]',
        penNumber: document.getElementById('penNumber').value || '',
        fatherName: document.getElementById('fatherName').value || '[Father]',
        motherName: document.getElementById('motherName').value || '[Mother]',
        parentsPhone: document.getElementById('parentsPhone').value || '[Phone]',
        address: document.getElementById('address').value || '[Address]',
        bankName: document.getElementById('bankName').value || '[Bank]',
        accountNumber: document.getElementById('accountNumber').value || 'XXXX',
        photoData: document.getElementById('photoPreview').src || ''
      };
      const admNode = createAdmissionPrintHTML(data);
      const w = window.open('', '_blank', 'width=900,height=1100');
      w.document.write('<html><head><title>Preview Admission</title></head><body>');
      w.document.write(admNode.innerHTML);
      w.document.write('</body></html>');
      w.document.close();
    }

    /* ---------- Register storage & UI ---------- */
    function loadRegister(){
      const arr = JSON.parse(localStorage.getItem('aps_register_v1') || '[]');
      renderRegister(arr);
    }
    function saveRecordToRegister(record){
      const arr = JSON.parse(localStorage.getItem('aps_register_v1') || '[]');
      arr.push({...record, status:'Active', createdAt: new Date().toISOString()});
      localStorage.setItem('aps_register_v1', JSON.stringify(arr));
      renderRegister(arr);
    }
    function renderRegister(arr){
      const tbody = document.querySelector('#registerTable tbody');
      tbody.innerHTML = '';
      arr.forEach((r, idx)=>{
        const tr = document.createElement('tr');
        const admDate = r.admDate || new Date().toLocaleDateString('en-GB');
        tr.innerHTML = `<td>${idx+1}</td>
          <td>${admDate}</td>
          <td>${r.admNo || ''}</td>
          <td>${r.studentName}</td>
          <td>${r.classApplying}</td>
          <td>${r.dob}</td>
          <td>${r.penNumber || ''}</td>
          <td>${r.bloodGroup||''}</td>
          <td>${r.fatherName} / ${r.motherName}</td>
          <td>${r.bankName ? '....'+String(r.accountNumber).slice(-4) : ''}</td>
          <td>
            <select onchange="updateStatus(${idx}, this.value)">
              <option ${r.status==='Active'?'selected':''}>Active</option>
              <option ${r.status==='Struck Off'?'selected':''}>Struck Off</option>
              <option ${r.status==='D.C. Issued'?'selected':''}>D.C. Issued</option>
            </select>
          </td>
          <td class="actions">
            <a href="${r.admPdf||'javascript:void(0)'}" target="_blank">Admission PDF</a>
            <a href="${r.apaarPdf||'javascript:void(0)'}" target="_blank">Apaar PDF</a>
          </td>`;
        tbody.appendChild(tr);
      });
    }
    function updateStatus(index, value){
      const arr = JSON.parse(localStorage.getItem('aps_register_v1') || '[]');
      if(!arr[index]) return;
      arr[index].status = value;
      localStorage.setItem('aps_register_v1', JSON.stringify(arr));
      renderRegister(arr);
    }

    /* ---------- Export ---------- */
    async function exportRegisterPDF(){
      const arr = JSON.parse(localStorage.getItem('aps_register_v1') || '[]');
      const node = document.createElement('div');
      node.style.padding='12px'; node.style.background='#fff';
      let html = `<h2>Admission Register ‚Äî Government Primary School Pethgam Wagoora</h2><table border="1" style="border-collapse:collapse;width:100%"><thead><tr>
        <th>S.No</th><th>Adm.No</th><th>Name</th><th>Class</th><th>DOB</th><th>PEN</th><th>Phone</th><th>Status</th></tr></thead><tbody>`;
      arr.forEach((r,i)=>{ html+=`<tr><td>${i+1}</td><td>${r.admNo||''}</td><td>${r.studentName}</td><td>${r.classApplying}</td><td>${r.dob}</td><td>${r.penNumber||''}</td><td>${r.parentsPhone}</td><td>${r.status||'Active'}</td></tr>`; });
      html += '</tbody></table>';
      node.innerHTML = html;
      document.body.appendChild(node);
      const pdf = await elementToPdfBlob(node);
      pdf.save('Admission_Register.pdf');
      document.body.removeChild(node);
    }
    function exportRegisterCSV(){
      const arr = JSON.parse(localStorage.getItem('aps_register_v1') || '[]');
      const rows = [['S.No','AdmNo','Name','Class','DOB','PEN','Phone','Status']];
      arr.forEach((r,i)=> rows.push([i+1, r.admNo||'', r.studentName, r.classApplying, r.dob, r.penNumber||'', r.parentsPhone, r.status||'Active']));
      const csv = rows.map(r=> r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='admission_register.csv'; a.click(); URL.revokeObjectURL(url);
    }

    /* ---------- Blank downloads ---------- */
    async function downloadBlank(type){
      if(type==='admission'){
        const dummy = { studentName:'[Student Name]', dob:'[DD/MM/YYYY]', classApplying:'[Class]', admNo:'[AdmNo]', admDate:'[Date]', penNumber:'[PEN]' , fatherName:'[Father]', motherName:'[Mother]', parentsPhone:'[Phone]', address:'[Address]', bankName:'[Bank]', accountNumber:'XXXX' };
        const node = createAdmissionPrintHTML(dummy);
        document.body.appendChild(node);
        const pdf = await elementToPdfBlob(node);
        pdf.save('Blank_Admission_Form_A4.pdf');
        document.body.removeChild(node);
      }else if(type==='apaar'){
        const node = createApaarPrintHTML({studentName:'[Student Name]', dob:'[DD/MM/YYYY]', classApplying:'[Class]'});
        document.body.appendChild(node);
        const pdf = await elementToPdfBlob(node);
        pdf.save('Blank_Apaar_Form_A4.pdf');
        document.body.removeChild(node);
      }
    }
  </script>
</body>
</html>













                                
    
